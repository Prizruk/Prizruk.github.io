<!DOCTYPE html>
<html>
<head>   
	<script>
		var givenMinutes = 0.2;
		var start = 0;
		var delta = 1;
		var correct = 0;
		var startedTimer = false;
		const answers = [3, [false,false,true,true], 1, 9.81];
		
		//Сбрасываем кнопки и время
		function resetAll(){
			//document.getElementById('qname').value = '';
			//document.getElementById('qemail').value = '';
			for (let i = 0; i < answers.length; i++){
				const buttons = document.querySelectorAll('input[name*="ques'+(i+1)+'"]');
				for (const button of buttons) {
					if (button.type == "radio" || button.type == "checkbox") {
						button.checked = false;
					}
					else {
						button.value = '';
					}
				}
			}
			document.getElementById("questions").hidden = true;

		}
		//Запускаем тест и таймер
		function setupTest(){
			start = Date.now() + givenMinutes*1000*60;
			delta = start - Date.now();

			startedTimer = true;
			document.getElementById("questions").hidden = false;
			document.getElementById("startTestButton").disabled = true;
		}
		
		//Проверяем данные перед запуском теста
		function checkInfo(){
			const checkname = document.getElementById('qname');
			if (!checkname.validity.valid){
				alert("ФИО введено неправильно");
				return;
			}
			const checkemail = document.getElementById('qemail');
			if (!checkemail.validity.valid){
				alert("email введён неправильно");
				return;
			}
			setupTest();
		}
		
		//Проверяем ответы
		function checkAnswers(){
			for (let i = 0; i < answers.length; i++){
				const buttons = document.querySelectorAll('input[name*="ques'+(i+1)+'"]');
				const corq = document.getElementById('question'+(i+1));
				//Автоматически неправильный, пока не правильный
				corq.style.color = "red";
				switch (buttons[0].type) {
					case 'radio':
						for (const button of buttons) {
							console.log(button.value + " " + answers[i]);
							if (button.checked) {
								if (button.value == answers[i]){
									corq.style.color = "green";
									correct += 1;
									break;
								}
							}				
						}
						break;
					case 'checkbox':
						var failedcheck = false;
						for (let j = 0; j < answers[i].length; j++){
							if (buttons[j].checked == answers[i][j]){
								correct += 1/(answers[i].length);
							}
							else {
								failedcheck = true;
							}
						}
						if (!failedcheck) corq.style.color = "green";
						break;
					case 'number':
						if (buttons[0].value == answers[i]) {
							corq.style.color = "green";
							correct += 1;
						}
				}
			}
			//Округляем до двух знаков
			correct = Math.round((correct + Number.EPSILON) * 100) / 100
			const correctPercent = correct / answers.length * 100;
			var resultText = "Вы получили " + correct + "/" + answers.length + " (" + correctPercent + "%)";			
			document.getElementById("testResults").innerHTML = resultText;
		}
		
		//Отмечаем правильный ответ
		function checkRight(corq){
			corq.style.color = "green";
		}
		
		//Убираем и выключаем по истечении времени
		function disableOnTimeout() {
			startedTimer = false;
			window.alert("Ваше время истекло");
			for (let i = 0; i < answers.length; i++){
				const buttons = document.querySelectorAll('input[name*="ques'+(i+1)+'"]');
				for (const button of buttons) {
					button.disabled = true;
				}
			}
			checkAnswers();
		}
		
		//Таймер
		function digitalClock() {
			var timertext = "Осталось "
			if (startedTimer){
				delta = start - Date.now();
				if (delta <= 0){
					givenMinutes = 0;
					disableOnTimeout();
				}
				else {
					var seconds = Math.floor(delta/1000);
					var minutes = 0;
					if (seconds > 60){
						minutes = Math.floor(seconds/60);
						seconds = seconds % 60;
					}
					//Добавление ведущих нулей и компановка
					if (minutes < 10) timertext += "0";
					timertext += minutes + ":";
					if (seconds < 10) timertext += "0";
					timertext += seconds;
					document.getElementById("id_clock").innerHTML = timertext;
					setTimeout("digitalClock()", 1000);
				}
			}
			else {
				if (givenMinutes < 10) timertext += "0";
				timertext += givenMinutes + ":00";
				document.getElementById("id_clock").innerHTML = timertext;
				setTimeout("digitalClock()", 1000);			
			}
		}

	</script>
	<title>Тест теста</title>
	<link rel="icon" type="image/x-icon" href="favicon.png">
	<style>
		input:invalid {
			border: red solid 3px;
		}
	</style>
</head>
<body onload="resetAll()">
	<h1>Тестовая версия тестовой страницы с тестом теста</h1>
	<h2>Личная информация</h2>
	<form id="personal_info" autocomplete="on">
		<label for="qname">ФИО (полностью):</label><br>
		<input type="text" id="qname" name="qname" size=40 minlength="5" required pattern="([а-яА-Я]+\s){2}[а-яА-Я]+$" placeholder="Иванов Иван Иванович"><br>
		<label for="qemail">email:</label><br>
		<input type="text" id="qemail" name="qemail" size=40 minlength="5" required pattern="^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z]+\.[a-zA-Z]+$" placeholder="klubnikove@yandex.ru"><br>
	</form>
	<p><button onclick="checkInfo()" id="startTestButton">Начать Тест</button></p>
	<div id="id_clock">
		<script>digitalClock();</script>
	</div>
	<form id="questions" autocomplete="off">
		<h2>Вопросы:</h2>
		<div id="question1">
			<p><b>1. Как называется минимальная скорость, которую необходимо придать телу, стартующему на поверхности Земли, чтобы оно могло преодолеть притяжение Земли и Солнца и покинуть пределы Солнечной системы</b></p>
			<input name="ques1" type="radio" value=1>Первая космическая<br>
			<input name="ques1" type="radio" value=2>Вторая космическая<br>
			<input name="ques1" type="radio" value=3>Третья космическая<br>
			<input name="ques1" type="radio" value=4>Четвёртая космическая<br>
		</div>
		<div id="question2">
			<p><b>2. Отметьте правдивые высказывания</b></p>
			<input type="checkbox" id="ques21" name="ques21">
			<label for="ques21">Земля плоская</label><br>
			<input type="checkbox" id="ques22" name="ques22">
			<label for="ques22">Солнце вращается вокруг Земли</label><br>
			<input type="checkbox" id="ques23" name="ques23">
			<label for="ques23">Луна вращается вокруг Земли</label><br>
			<input type="checkbox" id="ques24" name="ques24">
			<label for="ques24">Земля вращается вокруг своей оси</label><br>
		</div>
		<div id="question3">
			<p><b>3. Есть ли вода на Солнце?</p></b>
			<input name="ques3" type="radio" value=1>Да<br>
			<input name="ques3" type="radio" value=0>Нет<br>
		</div>
		<div id="question4">
			<p><b>4. Чему равно ускорение свободного падения на Земле в м/с<sup>2</sup>? Укажите с точностью до двух знаков после запятой.</b></p>
			<input name="ques4" id="ques4" type="number" step='0.01'><br>
		</div>
	</form>
	<p id="testResults"></p>
</body>
</html>