<!DOCTYPE html>
<html lang="ru">
<head>   
	<script>
		var givenMinutes = 3;
		var start = 0;
		var delta = 1;
		var correct = 0;
		var startedTimer = false;
		const answers = [3, [false,false,true,true], 1, 9.81, 'астрономия', '1957-10', 3, 3];
		
		//Сбрасываем кнопки и время
		function resetAll(){
			document.getElementById('qname').value = '';
			document.getElementById('qemail').value = '';
			for (let i = 0; i < answers.length; i++){
				const buttons = document.querySelectorAll('input[name*="ques'+(i+1)+'"]');
				for (const button of buttons) {
					if (button.type == "radio" || button.type == "checkbox") {
						button.checked = false;
					}
					else {
						button.value = '';
					}
				}
			}
			document.getElementById("questions").hidden = true;
			document.getElementById("endTestButton").hidden = true;
		}
		
		//Запускаем тест и таймер
		function setupTest(){
			start = Date.now() + givenMinutes*1000*60;
			delta = start - Date.now();
			startedTimer = true;
			document.getElementById("questions").hidden = false;
			document.getElementById("startTestButton").hidden = true;
			document.getElementById("endTestButton").hidden = false;
		}
		
		//Проверяем данные перед запуском теста
		function checkInfo(){
			const checkname = document.getElementById('qname');
			if (!checkname.validity.valid){
				alert("ФИО введено неправильно");
				return;
			}
			const checkemail = document.getElementById('qemail');
			if (!checkemail.validity.valid){
				alert("email введён неправильно");
				return;
			}
			setupTest();
		}
		
		//Проверяем ответы
		function checkAnswers(){
			for (let i = 0; i < answers.length; i++){
				const buttons = document.querySelectorAll('input[name*="ques'+(i+1)+'"]');
				const corq = document.getElementById('question'+(i+1));
				//Отмечаем все правильные
				var cora = document.querySelectorAll('label[id*="corr'+(i+1)+'"]');
				for (const correctAnswer of cora) {
					correctAnswer.style.fontWeight = "bold";
				}				
				//Автоматически неправильный, пока не правильный
				corq.style.color = "red";
				switch (buttons[0].type) {
					case 'radio':
						for (const button of buttons) {
							if (button.checked) {
								if (button.value == answers[i]){
									corq.style.color = "green";
									correct++;
									break;
								}
							}				
						}
						break;
					case 'checkbox':
						let sucesses = 0;
						for (let j = 0; j < answers[i].length; j++){
							if (buttons[j].checked == answers[i][j]){
								sucesses++;
							}
						}
						if (sucesses < answers[i].length/2) sucesses = 0;
						correct += 1/(answers[i].length)*sucesses;
						if (sucesses > 0 && sucesses < answers[i].length) corq.style.color = "gold";
						if (sucesses == answers[i].length) corq.style.color = "green";
						break;
					case 'number':
						if (buttons[0].value == answers[i]) {
							corq.style.color = "green";
							correct++;
						}
						break;
					case 'text':
						const textcheck = buttons[0].value.trim().toLowerCase();
						if (textcheck == answers[i]){
							corq.style.color = "green"
							correct++;
						}
						break;
					case 'month':
						if (buttons[0].value == answers[i]){
							corq.style.color = "green"
							correct++;
						}
						break;
				}
			}		
			//Округляем до двух знаков
			correct = Math.round((correct + Number.EPSILON) * 100) / 100
			const correctPercent = Math.round((correct / answers.length + Number.EPSILON) * 10000) / 100;
			const resultText = "Вы получили " + correct + "/" + answers.length + " (" + correctPercent + "%)";			
			document.getElementById("testResults").innerHTML = resultText;
		}
		
		//Отмечаем правильный ответ
		function checkRight(corq){
			corq.style.color = "green";
		}
		
		//Убираем и выключаем по истечении времени
		function disableOnTimeout() {
			startedTimer = false;
			if (delta <= 0) window.alert("Ваше время истекло");
			for (let i = 0; i < answers.length; i++){
				const buttons = document.querySelectorAll('input[name*="ques'+(i+1)+'"]');
				for (const button of buttons) {
					button.disabled = true;
				}
			}
			document.getElementById("endTestButton").hidden = true;
			document.getElementById("queclock").hidden = true;
			checkAnswers();
		}
		
		//Таймер
		function timerClock() {
			var timertext = "Осталось "
			if (startedTimer){
				delta = start - Date.now();
				if (delta <= 0){
					givenMinutes = 0;
					disableOnTimeout();
				}
				else {
					var seconds = Math.floor(delta/1000);
					var minutes = 0;
					if (seconds > 60){
						minutes = Math.floor(seconds/60);
						seconds = seconds % 60;
					}
					//Добавление ведущих нулей и компановка
					if (minutes < 10) timertext += "0";
					timertext += minutes + ":";
					if (seconds < 10) timertext += "0";
					timertext += seconds;
					document.getElementById("queclock").innerHTML = timertext;
					setTimeout("timerClock()", 1000);
				}
			}
			else {
				if (givenMinutes < 10) timertext += "0";
				timertext += givenMinutes + ":00";
				document.getElementById("queclock").innerHTML = timertext;
				setTimeout("timerClock()", 1000);			
			}
		}

	</script>
	<title>Тест теста</title>
	<link rel="icon" type="image/x-icon" href="favicon.png">
	<link rel="stylesheet" href="styles.css"/>
</head>
<body onload="resetAll()">
	<h1>Тестовая версия тестовой страницы с тестом теста</h1>
	<h2>Личная информация</h2>
	<form id="personal_info" autocomplete="on">
		<label for="qname">ФИО (полностью):</label><br>
		<input type="text" id="qname" name="qname" size=40 minlength="5" required pattern="([а-яА-Я]{3,}\s){2}[а-яА-Я]{3,}$" placeholder="Иванов Иван Иванович"><br>
		<label for="qemail">email:</label><br>
		<input type="text" id="qemail" name="qemail" size=40 minlength="5" required pattern="^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]{3,}@[a-zA-Z]{3,}\.[a-zA-Z]+$" placeholder="klubnikova@yandex.ru"><br>
	</form>
	<p><button onclick="checkInfo()" id="startTestButton">Начать Тест</button></p>
	<div id="queclock">	<script>timerClock();</script>
	</div>
	<form id="questions" autocomplete="off" hidden>
		<h2>Вопросы:</h2>
		<div id="question1">
			<p><b>1. Как называется минимальная скорость, которую необходимо придать телу, стартующему на поверхности Земли, чтобы оно могло преодолеть притяжение Земли и Солнца и покинуть пределы Солнечной системы?</b></p>
			<input name="ques1" type="radio" value=1>Первая космическая<br>
			<input name="ques1" type="radio" value=2>Вторая космическая<br>
			<input name="ques1" type="radio" value=3>Третья космическая<br>
			<input name="ques1" type="radio" value=4>Четвёртая космическая<br>
		</div>
		<div id="question2">
			<p><b>2. Отметьте правдивые высказывания:</b></p>
			<input name="ques21" type="checkbox" id="ques21">
			<label for="ques21">Земля плоская</label><br>
			<input name="ques22" type="checkbox" id="ques22">
			<label for="ques22">Солнце вращается вокруг Земли</label><br>
			<input name="ques23" type="checkbox" id="ques23">
			<label for="ques23" id="corr21">Луна вращается вокруг Земли</label><br>
			<input name="ques24" type="checkbox" id="ques24">
			<label for="ques24" id="corr22">Земля вращается вокруг своей оси</label><br>
		</div>
		<div id="question3">
			<p><b>3. Есть ли вода на Солнце?</p></b>
			<input name="ques3" type="radio" value=1>Да<br>
			<input name="ques3" type="radio" value=0>Нет<br>
		</div>
		<div id="question4">
			<p><b>4. Чему равно ускорение свободного падения на Земле в м/с<sup>2</sup>? Укажите с точностью до двух знаков после запятой.</b></p>
			<input name="ques4" type="number" id="ques4"  step='0.01'><br>
		</div>
		<div id="question5">
			<p><b>5. Как называется наука, изучающая происхождение и развитие небесных тел?</b></p>
			<input name="ques5" type="text" id="ques5"><br>
		</div>
		<div id="question6">
			<p><b>6. В каком году и месяце был запущен на орбиту первый искусственный спутник (Спутник-1)? Если не показывается календарь, впишите вручную в формате YYYY-MM.</b></p>
			<input name="ques6" type="month" id="ques6" min="1900-01" max="2019-31">
		</div>
		<div id="question7">
			<p><b>7. Кто изображён на плакате?</b></p>
			<img src="question7.jpg"><br>
			<input name="ques7" id="ques71" type="radio" value=1>
			<label for="ques71">Нил Армстронг</label><br>
			<input name="ques7" id="ques72" type="radio" value=2>
			<label for="ques72">Алексей Леонов</label><br>
			<input name="ques7" id="ques73" type="radio" value=3>
			<label for="ques73" id="corr7">Юрий Гагарин</label><br>
			<input name="ques7" id="ques74" type="radio" value=4>
			<label for="ques74">Герман Титов</label><br>
		</div>
		<div id="question8">
			<p><b>8. Как звали первое животное, выведенное на орбиту Земли?</b></p>
			<input name="ques8" id="ques81" type="radio" value=1>
			<label for="ques81">Стрелка</label><br>
			<input name="ques8" id="ques82" type="radio" value=2>
			<label for="ques82">Белка</label><br>
			<input name="ques8" id="ques83" type="radio" value=3>
			<label for="ques83" id="corr8">Лайка</label><br>
			<input name="ques8" id="ques84" type="radio" value=4>
			<label for="ques84">Чайка</label><br>
		</div>
	</form>
	<p><button onclick="disableOnTimeout()" id="endTestButton">Закончить Тест</button></p>
	<p id="testResults"></p>
</body>
</html>